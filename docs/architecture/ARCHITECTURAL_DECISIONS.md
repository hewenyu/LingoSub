# 服务端架构决策

本文档旨在讨论和记录 LingoSub 服务端实现的核心技术选型，以确保架构的健壮性、可扩展性和性能。

---

## 1. Python 服务端

Python 服务端负责处理核心的字幕翻译逻辑，需要具备接收文件、处理长任务、调用外部 AI 服务的能力。

### 1.1 Web 框架选型

Web 框架是 API 的基础。

*   **选项 A：FastAPI**
    *   **优点：**
        *   **高性能：** 基于 Starlette 和 Pydantic，拥有可与 NodeJS 和 Go 媲美的性能。
        *   **异步支持：** 原生支持 `async/await`，非常适合处理 I/O 密集型任务（如调用外部 LLM API）。
        *   **自动文档：** 自动生成交互式 API 文档（Swagger UI / ReDoc）。
        *   **数据验证：** 使用 Pydantic 进行强大的类型提示和数据验证，能有效减少 bug。
    *   **缺点：**
        *   对于新手，学习曲线可能比 Flask 稍陡峭。

*   **选项 B：Flask**
    *   **优点：**
        *   **简洁灵活：** 微框架，核心简单，易于上手和扩展。
        *   **生态成熟：** 拥有庞大的插件生态系统。
    *   **缺点：**
        *   **异步支持：** 异步支持不如 FastAPI 原生和完善（需要额外配置，如 Gunicorn + gevent/eventlet）。
        *   **文档与验证：** 需要手动集成其他库来实现 API 文档和数据验证。

*   **初步建议：**
    *   **推荐使用 `FastAPI`**。其原生异步特性和高性能非常契合本项目中与外部 AI 服务交互的场景。自动化的数据验证和 API 文档能极大提升开发效率和项目质量。

### 1.2 异步任务队列

字幕翻译是耗时操作，必须异步处理，不能阻塞 API 响应。

*   **选项 A：Celery (配合 Redis 或 RabbitMQ)**
    *   **优点：**
        *   **功能强大：** 生产级别的分布式任务队列，支持任务调度、重试、结果追踪、限速等复杂功能。
        *   **可靠稳定：** 经过大规模生产环境验证。
        *   **可扩展性强：** 可以独立于 Web 应用进行部署和扩展。
    *   **缺点：**
        *   **依赖较重：** 需要引入并维护一个消息中间件（Broker），如 Redis 或 RabbitMQ，配置相对复杂。

*   **选项 B：FastAPI 内置 `BackgroundTasks`**
    *   **优点：**
        *   **简单易用：** 无需任何额外依赖，直接在 FastAPI 应用中使用。
    *   **缺点：**
        *   **功能局限：** 适用于轻量级的后台任务（如发送邮件通知）。
        *   **可靠性低：** 如果服务器进程重启，正在执行或排队的任务会丢失。不提供重试机制。

*   **初步建议：**
    *   **推荐使用 `Celery`**。字幕翻译任务可能耗时较长，且对可靠性有一定要求。Celery 提供的稳定性和强大功能（如任务重试）是确保服务质量的关键。

---

## 2. Cloudflare Workers 服务端

Cloudflare Workers 提供了 Serverless 的部署环境，适合构建轻量、高可用的 API。

### 2.1 任务状态管理与执行

如何管理一个长耗时翻译任务的生命周期（如：已上传、处理中、已完成、失败）是核心问题。

*   **选项 A：Durable Objects**
    *   **优点：**
        *   **状态持久化：** 为单个 Worker 实例提供了持久化状态，非常适合用来将一个翻译任务抽象成一个对象，管理其完整的生命周期状态。
        *   **事务性保证：** 保证了对单个 Durable Object 的访问是串行的，避免了状态冲突。
        *   **避免超时：** 可以将长任务分解到 Durable Object 内部执行，绕开普通 Worker 的执行时间限制。
    *   **缺点：**
        *   **复杂度：** 模型比无状态的 Worker 更复杂。

*   **选项 B：无状态 Worker + KV Store**
    *   **优点：**
        *   **模型简单：** 易于理解的无状态请求/响应模型。
    *   **缺点：**
        *   **状态管理复杂：** 需要手动在 KV Store 中读写和同步任务状态，逻辑繁琐且容易出错。
        *   **执行时间限制：** 依然受限于 Worker 的 CPU 执行时间，处理长任务需要复杂的拆分和轮询逻辑。

*   **初步建议：**
    *   **推荐使用 `Durable Objects`**。它是 Cloudflare 平台为解决此类有状态、长生命周期任务而设计的标准方案，能以更优雅和可靠的方式实现字幕翻译任务的管理。

### 2.2 SRT 文件存储

需要地方存储用户上传的原始 SRT 文件和翻译后的最终文件。

*   **选项 A：R2 Storage**
    *   **优点：**
        *   **S3 兼容：** 提供了与 Amazon S3 兼容的 API。
        *   **大对象存储：** 专为大体积文件（如视频、图片、文档）设计。
        *   **成本效益：** 存储成本低，且无出口（下载）带宽费用。
    *   **缺点：**
        *   对于本项目来说，无明显缺点。

*   **选项 B：Workers KV**
    *   **优点：**
        *   **低延迟：** 全球分布的键值存储，读取速度极快。
    *   **缺点：**
        *   **大小限制：** Value 的大小限制为 25MB，不适合存储未来可能出现的大文件。
        *   **成本更高：** 主要为高频读写的小数据设计，用于文件存储的成本效益不如 R2。

*   **初步建议：**
    *   **推荐使用 `R2 Storage`**。它是 Cloudflare 平台上用于存储文件的标准、高性价比方案。 